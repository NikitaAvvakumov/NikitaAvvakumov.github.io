<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Removing Paperclip attachments &middot; Gemfile
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">

  <!-- Icons -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon" sizes="57x57" href="/public/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/public/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/public/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/public/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/public/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/public/manifest.json">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/public/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Gemfile" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Gemfile</a>
          &middot;
          <small>I codes and I blogs</small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Removing Paperclip attachments</h1>
  <time datetime="2014-04-27T13:54:08+03:00" class="post-date">27 Apr 2014</time>
  <p>Paperclip’s <a href="https://github.com/thoughtbot/paperclip#deleting-an-attachment">GitHub page</a> includes the necessary steps to delete an attachment - the model’s attribute that refers to the attachment simply gets set to nil. Here is the full implementation of deleting a user’s profile picture in a Rails app. Start with tests (right?!):</p>

<p><strong>spec/features/editing_users_spec.rb:</strong></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
<span class="n">feature</span> <span class="s1">&#39;Editing Users&#39;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scenario</span> <span class="s1">&#39;removing user profile photo&#39;</span> <span class="k">do</span>
    <span class="n">sign_in_as</span> <span class="n">admin</span> <span class="c1"># of course</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">click_link</span> <span class="s1">&#39;Remove profile photo&#39;</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">&#39;User profile photo has been removed.&#39;</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_css</span><span class="p">(</span><span class="s2">&quot;img[src*=&#39;user.png&#39;]&quot;</span><span class="p">)</span> <span class="c1"># file name of the user photo defined in the factory</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_css</span><span class="p">(</span><span class="s2">&quot;img[src*=&#39;paperclip_default.png&#39;]&quot;</span><span class="p">)</span> <span class="c1"># specified in the User model</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>(<a href="/2014/04/27/paperclip-attachments-in-factories/">This post</a> covers creation of an attachment in a FactoryGirl factory.)</p>

<a class="anchor" id="read-more"></a>

<p>Red. The test first fails when it tries to find a “Remove profile photo” link. In my implementation, photo removal takes place in the Edit view, so that’s where the link goes (or, to be more precise, into the ‘form’ partial):</p>

<p><strong>app/views/users/_form.html.erb:</strong></p>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:photo</span><span class="p">,</span> <span class="s1">&#39;Profile photo&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:photo</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Remove profile photo&#39;</span><span class="p">,</span> <span class="n">remove_user_photo_path</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">.</span>
<span class="x">.</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>

<p>(If the user has not been persisted to the database yet, as is the case when the partial is used by the New view to create a new user, the <code>link_to</code> cannot be generated as there is no user id yet - see <strong>routes.rb</strong> below. This is why it is wrapped in the <code>if..persisted?</code> clause.)</p>

<p>Red. In this iteration, the test fails because <code>remove_user_photo_path</code> is undefined. That’s next:</p>

<p><strong>config/routes.rb:</strong></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">get</span> <span class="s1">&#39;user/:id/remove_photo&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;users#remove_photo&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="s1">&#39;remove_user_photo&#39;</span>
<span class="k">end</span></code></pre></div>

<p>As can be seen from the route, the <code>link_to</code> method used in the view will generate a url such as <code>/user/1/remove_photo</code>, which is why having a user id (from a persisted user) is necessary.</p>

<p>Red. The test now fails because the <code>remove_photo</code> action does not exist in the Users controller. We are finally ready to make use of Paperclip’s instructions on deleting attachments:</p>

<p><strong>app/controllers/users_controller.rb:</strong></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">remove_photo</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">photo</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s1">&#39;User profile photo has been removed.&#39;</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>The action pulls the relevant user record out of the database, sets its attachment-referring <code>photo</code> attribute to <code>nil</code>, and saves the user to the database. It then redirects the browser to the user’s profile page, where the profile image now displays Paperclip’s default graphic and not the photo defined in the factory.</p>

<p>Green :)</p>

</article>


<aside class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/11/20/2015-11-19-test/">
            Test of LSN Reviews
            <small><time datetime="2015-11-20T16:05:48+02:00">20 Nov 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/10/31/how-constant-are-your-constants/">
            How constant are your constants?
            <small><time datetime="2015-10-31T00:00:00+02:00">31 Oct 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/08/31/false-security-of-hash-fetch/">
            Don't let Hash#fetch give you a false sense of security
            <small><time datetime="2015-08-31T00:00:00+03:00">31 Aug 2015</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'nikitaavvakumov';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2015-11-20T16:05:55+02:00">2015</time> Nikita Avvakumov.
          Happily made with <a href="http://demo.getpoole.com/">Poole</a>.
        </small>
      </footer>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64562360-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
