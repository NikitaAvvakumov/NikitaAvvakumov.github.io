<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      How constant are your constants? &middot; Gemfile
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">

  <!-- Icons -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon" sizes="57x57" href="/public/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/public/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/public/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/public/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/public/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/public/manifest.json">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/public/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Gemfile" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Gemfile</a>
          &middot;
          <small>I codes and I blogs</small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">How constant are your constants?</h1>
  <time datetime="2015-10-31T00:00:00+02:00" class="post-date">31 Oct 2015</time>
  <p>When an object should not change during the execution of a program, you make it
a constant:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">CONST</span> <span class="o">=</span> <span class="n">some_value</span></code></pre></div>

<p>Good forever, right? Well, not really. More accurately, perhaps, not at all.
First, there is the case of a simple reassignment:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">CONST</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;a&quot;</span>
 <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">CONST</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
<span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">2</span><span class="p">:</span> <span class="ss">warning</span><span class="p">:</span> <span class="n">already</span> <span class="n">initialized</span> <span class="n">constant</span> <span class="no">CONST</span>
<span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">1</span><span class="p">:</span> <span class="ss">warning</span><span class="p">:</span> <span class="n">previous</span> <span class="n">definition</span> <span class="n">of</span> <span class="no">CONST</span> <span class="n">was</span> <span class="n">here</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;b&quot;</span>
 <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="no">CONST</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;b&quot;</span></code></pre></div>

<p>Ruby issues a warning, but the constant still gets reassigned. This is perhaps
unfortunate, but at least it’s clear what happened. In other cases, the change
of a constant can take place by less obvious means and, to boot, without raising
any warnings.</p>

<a class="anchor" id="read-more"></a>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">CONST</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
 <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">CONST</span><span class="o">.</span><span class="n">map!</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">}</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
 <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="no">CONST</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span></code></pre></div>

<p>What’s going on? The critical thing to understand is that constants’ intended
use it to keep the object <em>reference</em> unchanged. This is why Ruby issues a
warning when a constant is reassigned to point to another object. However, the
<em>object</em> referenced by the constant is free of any constraint or
supervision from Ruby. Since the bang version of <code>.map</code> changes the referenced array in
place, Ruby sees no violation of the constant’s “constantness”.</p>

<p>The above example is rather contrived, while the change of the constant’s value
still happens in an obvious fashion. Here’s a version of it that is both more
realistic and less transparent:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="no">GREETING</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">greet_politely</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="no">GREETING</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">greet_enthusiastically</span>
    <span class="n">greeting</span> <span class="o">=</span> <span class="no">GREETING</span>
    <span class="p">(</span><span class="n">greeting</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39; there&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upcase!</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">greeting</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">joe</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Joe&#39;</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">joe</span><span class="o">.</span><span class="n">greet_enthusiastically</span>

<span class="n">jim</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Jim&#39;</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">jim</span><span class="o">.</span><span class="n">greet_politely</span>

<span class="c1"># outputs</span>
<span class="s2">&quot;HELLO THERE, Joe&quot;</span>
<span class="s2">&quot;HELLO THERE, Jim&quot;</span></code></pre></div>

<p>Jim was supposed to get a polite greeting but got a familiar “HELLO THERE”
instead. This happened because when Joe called <code>.greet_enthusiastically</code>, the
variable <code>greeting</code> was made to point to the same <code>"Hello"</code> string object
referenced by the constant <code>GREETING</code>. Via this new reference, the string had
“there” appended to it and then upcased, all in place. The end result of this
was that the class variable was irreversibly modified by a poorly designed
instance method.</p>

<p>The problem of inintentionally changing a constant’s value can be mitigated
somewhat by Ruby’s object freezing. However, this freezing is shallow and applies to the
object itself but not to its componets. Again, using an array as an example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">ary</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
 <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">CONST</span> <span class="o">=</span> <span class="o">[</span><span class="n">ary</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">freeze</span>
 <span class="o">=&gt;</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
 <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="no">CONST</span><span class="o">.</span><span class="n">map!</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">}</span>
<span class="ss">RuntimeError</span><span class="p">:</span> <span class="n">can</span><span class="s1">&#39;t modify frozen Array</span>
<span class="s1">  from (irb):3:in `map!&#39;</span>
  <span class="n">from</span> <span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">3</span>
  <span class="n">from</span> <span class="sr">/Users/use</span><span class="n">r</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="ss">irb</span><span class="p">:</span><span class="mi">11</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;&#39;</span>
<span class="sb"> :004 &gt; ary.map! { |n| n * 2 }</span>
<span class="sb"> =&gt; [2, 4]</span>
<span class="sb"> :005 &gt; CONST</span>
<span class="sb"> =&gt; [[2, 4], 3]</span></code></pre></div>

<p>While the array <code>[[1, 2], 3]</code> referenced by the constant could not be modified,
its constituent array referenced by <code>ary</code> remained free of any such
constraints. Any of Ruby’s methods that modify an object in
place will produce this effect.</p>

<p><em>This post was heavily inspired by the description of Ruby constants’ behaviour
in <a href="https://bearmetal.eu/theden/how-do-i-know-whether-my-rails-app-is-thread-safe-or-not/">this post</a>
from Bear Metal.</em></p>

</article>


<aside class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/02/08/sharing-rails-app-database-on-heroku/">
            Sharing a database between Rails apps on Heroku
            <small><time datetime="2016-02-08T00:00:00+02:00">08 Feb 2016</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/08/31/false-security-of-hash-fetch/">
            Don't let Hash#fetch give you a false sense of security
            <small><time datetime="2015-08-31T00:00:00+03:00">31 Aug 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/06/27/null-object/">
            Empowering Null Objects in a Rails application
            <small><time datetime="2015-06-27T00:00:00+03:00">27 Jun 2015</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'nikitaavvakumov';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-02-09T00:17:56+02:00">2016</time> Nikita Avvakumov.
          Happily made with <a href="http://demo.getpoole.com/">Poole</a>.
        </small>
      </footer>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64562360-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
