<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Empowering Null Objects in a Rails application &middot; Gemfile
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">

  <!-- Icons -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="apple-touch-icon" sizes="57x57" href="/public/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/public/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/public/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/public/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/public/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/public/manifest.json">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/public/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Gemfile" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Gemfile</a>
          &middot;
          <small>I codes and I blogs</small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Empowering Null Objects in a Rails application</h1>
  <time datetime="2015-06-27T00:00:00+03:00" class="post-date">27 Jun 2015</time>
  <p>Null Object is a well-known software design pattern that allows one to take advantage of
duck-typing encouraged by Ruby. Plenty of articles offer good descriptions of
this pattern and provide basic usage examples, which has prompted me to attempt
integrating it into my Rails apps several times. Unfortunately, null objects
always seemed to fall short of being able to fully replace nil checks and other
conditionals. Luckily, Sandi Metz took a terriffic in-depth look at this pattern
in a <a href="http://confreaks.tv/videos/railsconf2015-nothing-is-something">recent talk</a>.
Inspired by this presentation, I returned to the Null Object pattern and finally
implemented it in a way that unlocks its full potential while leaving the code
base clean and compartmentalized.</p>

<a class="anchor" id="read-more"></a>

<h2 id="implementing-a-rudimentary-null-object-in-a-rails-application">Implementing a rudimentary Null Object in a Rails application</h2>

<p>A common example of using null objects in a Rails app has to do with
<code>current_user</code>. With <code>user.id</code> stored in the session, a simple helper method might be
implemented as</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">current_user</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>

<p>As written, the method returns a <code>User</code> object if a user is signed in or <code>nil</code>
otherwise. This necessitates a nil check in the view:</p>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  Welcome, </span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  Welcome, Guest</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>

<p>A basic Null Object implementation can go a short way towards mitigating the
problem:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/guest.rb</span>
<span class="k">class</span> <span class="nc">Guest</span>
  <span class="k">def</span> <span class="nf">name</span>
    <span class="s2">&quot;Guest&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># helper</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span> <span class="o">||</span> <span class="no">Guest</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%#</span><span class="c"> view </span><span class="cp">%&gt;</span><span class="x"></span>
<span class="x">Welcome, </span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>

<p>This implementation is not only messy but also half-hearted, as it merely
shuffles the conditional out of the view and into the helper. One way to clean
it up might be to override the <code>find</code> and/or <code>find_by</code> methods of <code>User</code>:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_by</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">super</span> <span class="o">||</span> <span class="no">Guest</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="k">super</span>
    <span class="k">rescue</span>
      <span class="no">Guest</span><span class="o">.</span><span class="n">new</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># the helper returns to its original implementation</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>

<p>While less than ideal, this implementation of the Null Object pattern is
functional, and this is where many article examples stop.</p>

<h2 id="going-beyond-the-basics">Going beyond the basics</h2>

<p>There are some questions that can help take this implementation of the Null
Object pattern further:</p>

<ul>
  <li>
    <p>Should the <code>User</code>
class, which already handles persistence of user records and possibly other
duties, be responsible for creating and returning new <code>Guest</code> objects? (Class
naming is deliberate here: had the null object been named <code>NullUser</code>, it would have been
more tempting to have <code>User</code> return a “null version of self”. A <code>Guest</code>, on the
other hand, is clearly a distinct entity from <code>User</code>.) Or does this responsibility
belong to a view helper, whose job is just to provide some reusable convenience methods
for views? Neither option feels right.</p>
  </li>
  <li>
    <p>What happens when one wishes to extend the view in this fairly common way:</p>
  </li>
</ul>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="x">Welcome, </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>

<p>Rails is smart enough to route a reference to a <code>User</code> object to
<code>UsersController#show</code>, but it won’t be able to do anything with an instance of
<code>Guest</code>. Not yet, anyway.</p>

<h2 id="extracting-new-responsibility">Extracting new responsibility</h2>
<p>To address the first question, one can ask if determining whether a person is a
user or a guest is a job worthy of a brand new class. Sandi’s talk makes a
strong case for answering this in the affirmative. In her presentation, she
drives the point home by naming the new class <code>GuaranteedAnimal</code> - whether the
sought <code>Animal</code> object exists or not, the <code>GuaranteedAnimal</code> class will return
something that will look and waddle and quack like an <code>Animal</code>.</p>

<p>And so, the <code>User</code> class can lose its custom <code>find</code> and <code>find_by</code> methods and resume its
(hopefully) single responsibility of persisting user data. Instead, a new class is
created to encapsulate the <code>User</code>/<code>Guest</code> dichotomy:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span> <span class="o">||</span> <span class="no">Guest</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># helper</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>

<p>(It makes sense to propagate the <code>user</code> -&gt; <code>person</code> change to the
helper method and into the views, but I’m keeping it as <code>current_user</code> for
clarity.)</p>

<p>Just like <code>GuaranteedAnimal</code>, <code>Person.find</code> is now sure to return an object that
will respond to all messages sent to it by other components of the application.
This approach eliminates the need for type checks and neatly encapsulates the
responsibility for determining the type of person interacting with the app.</p>

<h2 id="empowering-the-null-object">Empowering the null object</h2>
<p>What about being able to do</p>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>

<p>Rails knows how to route to a <code>User</code> because <strong>routes.rb</strong> probably contains</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resources</span> <span class="ss">:users</span></code></pre></div>

<p>Soooooo… Why not</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resources</span> <span class="ss">:guests</span></code></pre></div>

<p>If the application is made with any care, there should never be a reason to
handle anything but <code>show</code> for a guest, so <code>resources :guests</code> is overkill,
but it drives the point home - treating this null object as a first-class
citizen in the app allows it to perform all the duties of a <code>User</code> doppelganger.
<code>GuestsController</code> may do nothing more than redirect to sign-up/sign-in
pages, but it serves the higher purpose of putting <code>Guest</code> on fully equal footing with <code>User</code>, which
allows the former to stand in for the latter in all usage scenarios.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Null objects exist to eliminate the need for nil checking (which is just a
variant of type checking), and to fully enable Ruby’s duck typing and
polymorphism. However, null objects can be easily crippled when they are
pigeonholed into the “support” category, and their half-baked implementations
can force their code to pollute other classes. Code awkwardness and SRP
violations can be cleaned up by diligently extracting new objects to encapsulate
discrete bits of functionality. Moreover, full potential of null objects can be unlocked
only when they are treated as first-class citizens within an application.</p>

</article>


<aside class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/02/08/sharing-rails-app-database-on-heroku/">
            Sharing a database between Rails apps on Heroku
            <small><time datetime="2016-02-08T00:00:00+02:00">08 Feb 2016</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/10/31/how-constant-are-your-constants/">
            How constant are your constants?
            <small><time datetime="2015-10-31T00:00:00+02:00">31 Oct 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/08/31/false-security-of-hash-fetch/">
            Don't let Hash#fetch give you a false sense of security
            <small><time datetime="2015-08-31T00:00:00+03:00">31 Aug 2015</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'nikitaavvakumov';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-02-09T00:17:56+02:00">2016</time> Nikita Avvakumov.
          Happily made with <a href="http://demo.getpoole.com/">Poole</a>.
        </small>
      </footer>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64562360-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
